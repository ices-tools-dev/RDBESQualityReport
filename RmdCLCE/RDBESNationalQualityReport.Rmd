---
# date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 4
    number_sections: true
    toc_float: true
params:
  year: year
  region: region
  RDBESfile: RDBESfile
  eurostat: eurostat
  prelcatchstat: prelcatchstat
  prelcatchFile: prelcatchFile
  fleetRegister: fleetRegister
  fleetRegisterFile: fleetRegisterFile
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.height = 10, fig.width = 14)
options(scipen=999)
```

```{r}
# Packages 
# Installs missing packages automatically 
list.of.packages <- c("icesVocab", "tidyverse", "eurostat", "DT")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

# Loads packages 
library(icesVocab)
library(tidyverse, quietly = TRUE)
library(eurostat)
library(DT)
# library(RDBEScore)
```


```{r}
# Functions 
# TODO add catHeader to script and load them all at once 
source("../Functions/read.rdbes.R")
source("../Functions/read.prelC.R")
source("../Functions/read.fleet.R")
catHeader <- function(text = "", level = 3) {
    cat(paste0("\n\n", 
               paste(rep("#", level), collapse = ""), 
               " ", text, "\n"))
}

```

```{r}
url <- "https://raw.githubusercontent.com/ices-eg/RCGs/master/Metiers/Reference_lists/AreaRegionLookup.csv"
Area <- read.csv(url, header = TRUE)
### Fix the extra space in rcg region code
Area <- mutate(Area, Code = ifelse(Code %in% "NSEA                                    " , "NSEA",
                             ifelse(Code %in% "NAtl                                      ", "NAtl", Code))) %>%
  select(AreaCode, Code)

```



```{r}
# Read RDBES CL, CE files 
# df <- createRDBESDataObject(params$RDBESfile) # overwrites if given multiple zip files with the same tables
# check what happens if all years are in one zip folder when time series are uploaded 
# For now use this 
df <- read.rdbes(params$RDBESfile)
CL <- as.data.frame(df[1])
CE <- as.data.frame(df[2])
```

```{r}
clY <- sort(unique(CL$CLyear))
ceY <- sort(unique(CE$CEyear))
# TODO add consistency checks between CL and CE and add warning for the comparison of both if there are
# no matching years 

if(all(clY == ceY) & length(unique(clY)) > 1){
  titleR <- paste("National quality report for years", paste(clY, collapse = ", "))
}else{
  titleR <- paste("National quality report for year ", clY)
}
```

---
title: `r titleR`
---



```{r}
# Processing 
# Get species scientific name from aphiaID
ScName <- getCodeList("SpecWorms") %>%
  select(Description, Key) %>%
  rename(LatinName = Description)
CL <- left_join(CL, ScName, by = c("CLspeciesCode" = "Key")) 
```

```{r}

# CL$CLcatchCategory <- "RegDis"
# CL$CLregDisCategory <- "Deminimis"

```

# Summary 

Add text with a brief summary describing what the document's purpose is etc. 

```{r}
# Number of records 
CLr <- CL %>%
  group_by(CLyear) %>%
  count() %>%
  mutate(Dataset = "CL") %>%
  rename(Year = CLyear)
CEr <- CE %>%
  group_by(CEyear) %>%
  count() %>%
  mutate(Dataset = "CE") %>%
  rename(Year = CEyear)
tabN <- rbind(CLr, CEr) %>%
  spread(Year, n) 

tabN %>%
  datatable(caption = "Number of records in the CL and CE tables by year", options = list(dom = 't'))
```


```{r}
# Numbers of metier lvl 6 
CLm <- CL %>%
  group_by(CLyear) %>%
  summarise(Nmet = length(unique(CLmetier6))) %>%
  mutate(Dataset = "CL") %>%
  rename(Year = CLyear)
CEm <- CE %>%
  group_by(CEyear) %>%
  summarise(Nmet = length(unique(CEmetier6))) %>%
  mutate(Dataset = "CE") %>%
  rename(Year = CEyear)
tabN <- rbind(CLm, CEm) %>%
  spread(Year, Nmet) 

tabN %>%
  datatable(caption = "Number of unique metiers level 6 in the CL and CE tables by year", options = list(dom = 't'))

```

```{r}
# Number of unique vessels by year 

CLv <- select(CL, CLyear, CLencryptedVesselIds) %>%
  distinct() %>%
  separate_rows(CLencryptedVesselIds, convert = TRUE) %>%
  distinct() %>%
  group_by(CLyear) %>%
  summarise(NumberOfUniqueVessels = length(unique(CLencryptedVesselIds))) %>%
  mutate(Dataset = "CL") %>%
  rename(Year = CLyear)
CEv <- select(CE, CEyear, CEencryptedVesselIds) %>%
  distinct() %>%
  separate_rows(CEencryptedVesselIds, convert = TRUE) %>%
  distinct()%>%
  group_by(CEyear) %>%
  summarise(NumberOfUniqueVessels = length(unique(CEencryptedVesselIds)))%>%
  mutate(Dataset = "CE") %>%
  rename(Year = CEyear)

tabV <- rbind(CLv, CEv)%>%
  spread(Year, NumberOfUniqueVessels) 
tabV %>%
  datatable(caption = "Number of unique vessels in the CL and CE tables by year", options = list(dom = 't'))
```


```{r}
# Number of species
CLsp <- CL %>%
  group_by(CLyear) %>%
  summarise(NumberOfSpecies = length(unique(CLspeciesCode)))

CLsp %>%
  datatable(caption = "Number of species by year in the CL table" , colnames = c("Year" = 1), rownames = FALSE, options = list(dom = 't'))

```


```{r}
# Run next chunk? 
doNextChunk <- any(c(params$eurostat, params$prelcatchstat, params$fleetRegister))
```


```{r, results='asis', eval = doNextChunk}
cat("# Comparison with auxiliary data sources")
```



```{r, eval = params$eurostat}
# Auxiliary information for comparisons 
# 1. Eurostat data - weight 
eurostatW <- get_eurostat("tag00076", time_format = "num", filters = list(geo = unique(CL$CLlandingCountry)), stringsAsFactors = TRUE) # tag corresponds to catches in all fishing regions by country
# https://ec.europa.eu/eurostat/databrowser/view/tag00076/default/table?lang=en&category=t_fish

# 2. Eurostat data - number of vessels 
# eurostatV <- get_eurostat("tag00076", time_format = "num", filters = list(geo = unique(CL$CLlandingCountry)), stringsAsFactors = TRUE)

```

```{r,  child = '01_Eurostat.Rmd', eval = params$eurostat}

```

```{r, eval = params$prelcatchstat}
# 2. ICES preliminary catches
prelC <- read.prelC(params$prelcatchFile)
```


```{r,  child = '03_PreliminaryCatches.Rmd', eval = params$prelcatchstat}

```


```{r, eval = params$fleetRegister}
# 3. Fleet register 
fleet <- read.fleet(params$fleetRegisterFile)
```

```{r, child = '04_FleetRegister.Rmd', eval = params$fleetRegister}

```



```{r, child = 'CL_Multiannual.Rmd'}

```

```{r, child = 'CE_Multiannual.Rmd'}

```


```{r, child = 'CLCE_Multiannual.Rmd'}

```

